<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gabung Komunitas - TSecNetwork</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/particles.js/2.0.0/particles.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://www.google.com/recaptcha/api.js"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="form.css">
    <link rel="stylesheet" href="../rss/styles.css">
</head>
<body>
    <div id="particles-js"></div>
    <div class="cyber-grid"></div>
    <div id="root"></div>

    <script type="text/babel">
        const App = () => {
            const [isSubmitted, setIsSubmitted] = React.useState(false);
            const [isValidUrl, setIsValidUrl] = React.useState(true);
            const [isLoading, setIsLoading] = React.useState(false);
            const [formErrors, setFormErrors] = React.useState({});
            const [submissionCount, setSubmissionCount] = React.useState(() => {
                const count = localStorage.getItem('submissionCount');
                return count ? parseInt(count) : 0;
            });
            
            // Timer untuk throttling
            const [timeRemaining, setTimeRemaining] = React.useState(0);
            const [timerActive, setTimerActive] = React.useState(false);

            React.useEffect(() => {
                // Cek jika ada waktu cooldown yang tersimpan
                const cooldownUntil = localStorage.getItem('cooldownUntil');
                if (cooldownUntil) {
                    const remainingTime = Math.max(0, parseInt(cooldownUntil) - new Date().getTime());
                    if (remainingTime > 0) {
                        setTimeRemaining(Math.ceil(remainingTime / 1000));
                        setTimerActive(true);
                    }
                }
            }, []);

            React.useEffect(() => {
                let timer;
                if (timerActive && timeRemaining > 0) {
                    timer = setTimeout(() => {
                        setTimeRemaining(timeRemaining - 1);
                    }, 1000);
                } else if (timerActive && timeRemaining === 0) {
                    setTimerActive(false);
                }
                return () => clearTimeout(timer);
            }, [timeRemaining, timerActive]);

            const verifyYouTubeUrl = (url) => {
                if (!url) return false;
                const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/)[\w-]{11}$/;
                return youtubeRegex.test(url);
            };

            const validateForm = (data) => {
                const errors = {};
                
                // Validasi email
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(data.email)) {
                    errors.email = "Email tidak valid";
                }
                
                // Validasi nickname (tidak boleh kosong dan memiliki panjang minimum)
                if (!data.nick || data.nick.length < 3) {
                    errors.nick = "Nick harus memiliki minimal 3 karakter";
                }
                
                // Validasi URL video
                if (!verifyYouTubeUrl(data.videoUrl)) {
                    errors.videoUrl = "URL video harus dari YouTube dan valid";
                }
                
                // Validasi deskripsi video
                if (!data.videoDescription || data.videoDescription.length < 10) {
                    errors.videoDescription = "Deskripsi video harus memiliki minimal 10 karakter";
                }
                
                // Validasi sosmed
                if (!data.socialMedia) {
                    errors.socialMedia = "Sosmed tidak boleh kosong";
                }
                
                // Validasi zone
                if (!data.zone) {
                    errors.zone = "Zone tidak boleh kosong";
                }
                
                return errors;
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                // Reset errors
                setFormErrors({});
                
                // Cek jika sedang dalam cooldown
                if (timerActive) {
                    alert(`Mohon tunggu ${timeRemaining} detik sebelum mengirim formulir lagi.`);
                    return;
                }
                
                // Cek honeypot
                const honeypot = document.querySelector('input[name="honeypot"]').value;
                if (honeypot) {
                    console.log("Honeypot terisi, kemungkinan bot");
                    setIsSubmitted(true); // Fake success untuk bot
                    return;
                }
                
                // Dynamic throttling berdasarkan jumlah submission
                const submissionLimits = [
                    { count: 3, delay: 60 },    // 1 menit setelah 3 submission
                    { count: 5, delay: 300 },   // 5 menit setelah 5 submission
                    { count: 10, delay: 1800 }, // 30 menit setelah 10 submission
                    { count: 15, delay: 3600 }  // 1 jam setelah 15 submission
                ];
                
                // Cek IP address dengan fingerprinting sederhana
                const fingerprint = await getFingerprint();
                const lastFingerprintTime = localStorage.getItem(`lastSubmission_${fingerprint}`);
                const currentTime = new Date().getTime();
                
                // Jika fingerprint sama dengan submission sebelumnya dalam 1 jam
                if (lastFingerprintTime && currentTime - lastFingerprintTime < 3600000) {
                    const newSubmissionCount = submissionCount + 1;
                    
                    // Cek apakah perlu throttling
                    for (const limit of submissionLimits) {
                        if (newSubmissionCount === limit.count) {
                            const delayMs = limit.delay * 1000;
                            const cooldownUntil = currentTime + delayMs;
                            
                            localStorage.setItem('cooldownUntil', cooldownUntil.toString());
                            setTimeRemaining(limit.delay);
                            setTimerActive(true);
                            
                            alert(`Anda telah mengirim ${limit.count} formulir. Harap tunggu ${limit.delay} detik sebelum mengirim formulir berikutnya.`);
                            return;
                        }
                    }
                    
                    setSubmissionCount(newSubmissionCount);
                    localStorage.setItem('submissionCount', newSubmissionCount.toString());
                }

                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                
                // Validasi form
                const errors = validateForm(data);
                if (Object.keys(errors).length > 0) {
                    setFormErrors(errors);
                    return;
                }
                
                setIsLoading(true);

                try {
                    // Tambahkan timestamp untuk mencegah caching
                    const timestamp = new Date().getTime();
                    data.timestamp = timestamp;
                    
                    // Dapatkan token reCAPTCHA
                    const recaptchaToken = await executeRecaptcha();
                    if (!recaptchaToken) {
                        alert('Harap selesaikan CAPTCHA.');
                        setIsLoading(false);
                        return;
                    }
                    
                    // Kirim data ke Formspree atau layanan lainnya
                    const response = await fetch("https://formspree.io/f/xblgjkrd", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            ...data,
                            'g-recaptcha-response': recaptchaToken,
                            fingerprint: fingerprint,
                            userAgent: navigator.userAgent,
                            screenSize: `${window.screen.width}x${window.screen.height}`,
                            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                        }),
                    });
                    
                    if (response.ok) {
                        setIsSubmitted(true);
                        
                        // Simpan waktu submission dan fingerprint
                        localStorage.setItem(`lastSubmission_${fingerprint}`, currentTime.toString());
                        
                        // Tingkatkan counter submission
                        const newCount = submissionCount + 1;
                        setSubmissionCount(newCount);
                        localStorage.setItem('submissionCount', newCount.toString());
                    } else {
                        alert("Terjadi kesalahan saat mengirim formulir. Silakan coba lagi.");
                    }
                } catch (error) {
                    console.error("Error:", error);
                    alert("Terjadi kesalahan. Silakan coba lagi.");
                } finally {
                    setIsLoading(false);
                }
            };
            
            // Fungsi untuk membuat fingerprint sederhana berdasarkan informasi browser
            const getFingerprint = async () => {
                const components = [
                    navigator.userAgent,
                    navigator.language,
                    new Date().getTimezoneOffset(),
                    screen.width + 'x' + screen.height,
                    navigator.platform
                ];
                
                const fingerprintString = components.join('||');
                
                // Buat hash sederhana
                let hash = 0;
                for (let i = 0; i < fingerprintString.length; i++) {
                    const char = fingerprintString.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                
                return hash.toString();
            };

            // Fungsi untuk menjalankan reCAPTCHA
            const executeRecaptcha = () => {
                return new Promise((resolve) => {
                    grecaptcha.ready(() => {
                        grecaptcha.execute('6LeWiPAqAAAAAITrwg321f-VOgaqjNBiXNKghgxC', { action: 'submit' }).then((token) => {
                            resolve(token);
                        });
                    });
                });
            };

            return (
                <div className="container">
                    <a href="../index.html" className="back-button" data-aos="fade-right">
                        <i className="fas fa-arrow-left"></i> Kembali
                    </a>

                    <section id="form" className="form-section" data-aos="fade-up">
                        <h2><i className="fas fa-user-plus"></i> Yok Jadi Anggota Kami</h2>
                        <p>Isi form di bawah ini untuk bergabung dengan komunitas kami.</p>

                        {isSubmitted ? (
                            <div className="success-message">
                                <h3>Terima kasih telah mengirimkan formulir!</h3>
                                <p>
                                    Jika arsipan valid, arsipan Anda akan ada di e-learning, dan jika anda belum menjadi anggota link untuk gabung ke grup WhatsApp TSecNetwork akan dikirim ke email Anda. Mohon untuk ditunggu pesannya, setelah itu anda resmi menjadi anggota tsecnetwork.
                                </p>
                            </div>
                        ) : (
                            <>
                                {timerActive && (
                                    <div className="cooldown-message">
                                        <p>Anda dapat mengirim formulir lagi dalam: <strong>{timeRemaining}</strong> detik</p>
                                    </div>
                                )}
                                
                                <form onSubmit={handleSubmit}>
                                    <label>
                                        Email Anda:
                                        <input 
                                            type="email" 
                                            name="email" 
                                            required 
                                            className={formErrors.email ? "error-input" : ""}
                                        />
                                        {formErrors.email && (
                                            <p className="error-message">{formErrors.email}</p>
                                        )}
                                    </label>
                                    <label>
                                        Nick Anda:
                                        <input 
                                            type="text" 
                                            name="nick" 
                                            required 
                                            className={formErrors.nick ? "error-input" : ""}
                                        />
                                        {formErrors.nick && (
                                            <p className="error-message">{formErrors.nick}</p>
                                        )}
                                    </label>
                                    <label>
                                        URL Video:
                                        <input
                                            type="url"
                                            name="videoUrl"
                                            required
                                            onChange={(e) => setIsValidUrl(verifyYouTubeUrl(e.target.value))}
                                            className={formErrors.videoUrl ? "error-input" : ""}
                                        />
                                        {formErrors.videoUrl && (
                                            <p className="error-message">{formErrors.videoUrl}</p>
                                        )}
                                        {!isValidUrl && !formErrors.videoUrl && (
                                            <p className="error-message">URL video harus dari YouTube dan valid.</p>
                                        )}
                                    </label>
                                    <label>
                                        Target di Video (Opsional):
                                        <input type="text" name="videoTarget" />
                                    </label>
                                    <label>
                                        Deskripsi Video:
                                        <textarea 
                                            name="videoDescription" 
                                            required
                                            className={formErrors.videoDescription ? "error-input" : ""}
                                        ></textarea>
                                        {formErrors.videoDescription && (
                                            <p className="error-message">{formErrors.videoDescription}</p>
                                        )}
                                    </label>
                                    <label>
                                        Sosmed:
                                        <textarea 
                                            name="socialMedia" 
                                            required
                                            className={formErrors.socialMedia ? "error-input" : ""}
                                        ></textarea>
                                        {formErrors.socialMedia && (
                                            <p className="error-message">{formErrors.socialMedia}</p>
                                        )}
                                    </label>
                                    <label>
                                        Zone:
                                        <textarea 
                                            name="zone" 
                                            required
                                            className={formErrors.zone ? "error-input" : ""}
                                        ></textarea>
                                        {formErrors.zone && (
                                            <p className="error-message">{formErrors.zone}</p>
                                        )}
                                    </label>
                                    
                                    {/* Tambahkan timestamp tersembunyi */}
                                    <input type="hidden" name="timestamp" value={new Date().getTime()} />
                                    
                                    {/* Honeypot Field */}
                                    <label style={{ display: "none" }}>
                                        Jangan isi field ini:
                                        <input type="text" name="honeypot" tabIndex="-1" autoComplete="off" />
                                    </label>
                                    
                                    {/* CAPTCHA tersembunyi */}
                                    <div className="g-recaptcha-container" style={{ opacity: 0, height: 0, overflow: 'hidden' }}>
                                        <div className="g-recaptcha" data-sitekey="6LeWiPAqAAAAAITrwg321f-VOgaqjNBiXNKghgxC"></div>
                                    </div>
                                    
                                    <button
                                        type="submit"
                                        disabled={!isValidUrl || isLoading || timerActive}
                                        className={`submit-btn ${isLoading ? 'loading' : ''}`}
                                    >
                                        {isLoading ? 'Mengirim...' : 'Kirim'}
                                    </button>
                                </form>
                            </>
                        )}

                        <div className="terms" data-aos="fade-up" data-aos-delay="100">
                            <h3>Ketentuan:</h3>
                            <ul>
                                <li>Arsipan yang valid akan dimasukkan ke dalam e-learning TSecNetwork.</li>
                                <li>Jika anda belum jadi anggota, link untuk gabung ke grup WhatsApp TSecNetwork akan dikirim ke email Anda.</li>
                                <li>Pastikan email yang Anda masukkan valid.</li>
                                <li>Sistem akan membatasi jumlah pengiriman formulir untuk mencegah spam.</li>
                            </ul>
                        </div>
                    </section>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            particlesJS('particles-js', {
                "particles": {
                    "number": { "value": 80, "density": { "enable": true, "value_area": 800 } },
                    "color": { "value": "#64ffda" },
                    "shape": { "type": "circle", "stroke": { "width": 0, "color": "#000000" }, "polygon": { "nb_sides": 5 } },
                    "opacity": { "value": 0.5, "random": false, "anim": { "enable": false, "speed": 1, "opacity_min": 0.1, "sync": false } },
                    "size": { "value": 3, "random": true, "anim": { "enable": false, "speed": 40, "size_min": 0.1, "sync": false } },
                    "line_linked": { "enable": true, "distance": 150, "color": "#64ffda", "opacity": 0.4, "width": 1 },
                    "move": { "enable": true, "speed": 3, "direction": "none", "random": false, "straight": false, "out_mode": "out", "bounce": false, "attract": { "enable": true, "rotateX": 600, "rotateY": 1200 } }
                },
                "interactivity": {
                    "detect_on": "canvas",
                    "events": {
                        "onhover": { "enable": true, "mode": "grab" },
                        "onclick": { "enable": true, "mode": "push" },
                        "resize": true
                    },
                    "modes": {
                        "grab": { "distance": 140, "line_linked": { "opacity": 1 } },
                        "bubble": { "distance": 400, "size": 40, "duration": 2, "opacity": 8, "speed": 3 },
                        "repulse": { "distance": 200, "duration": 0.4 },
                        "push": { "particles_nb": 4 },
                        "remove": { "particles_nb": 2 }
                    }
                },
                "retina_detect": true
            });

            AOS.init({
                duration: 800,
                easing: 'ease-in-out',
                once: false
            });

            gsap.from(".form-section", { duration: 1, y: 50, opacity: 0, delay: 0.5, ease: "power2.out" });
            gsap.from(".back-button", { duration: 1, x: -50, opacity: 0, delay: 1, ease: "power2.out" });
            
            // Tambahkan CSS untuk button loading state
            const style = document.createElement('style');
            style.textContent = `
                .error-input {
                    border: 1px solid #ff3860 !important;
                }
                .error-message {
                    color: #ff3860;
                    font-size: 0.8rem;
                    margin-top: 5px;
                }
                .submit-btn.loading {
                    position: relative;
                    color: transparent !important;
                }
                .submit-btn.loading:after {
                    content: '';
                    position: absolute;
                    width: 20px;
                    height: 20px;
                    top: 50%;
                    left: 50%;
                    margin-top: -10px;
                    margin-left: -10px;
                    border-radius: 50%;
                    border: 2px solid rgba(255, 255, 255, 0.3);
                    border-top-color: white;
                    animation: spinner 0.8s linear infinite;
                }
                @keyframes spinner {
                    to {transform: rotate(360deg);}
                }
                .cooldown-message {
                    background-color: rgba(255, 204, 0, 0.1);
                    border: 1px solid rgba(255, 204, 0, 0.3);
                    border-radius: 4px;
                    padding: 10px 15px;
                    margin-bottom: 20px;
                    text-align: center;
                }
                .cooldown-message p {
                    color: #ff9900;
                    margin: 0;
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>
